<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta content="IE=edge" http-equiv="X-UA-Compatible">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link href="style.css" rel="stylesheet">
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
        <title>Weather</title>
    </head>
    <body>
        <div class="text-center">
            <svg version="1.1" id="L9" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 100 100" enable-background="new 0 0 0 0" xml:space="preserve" width="60px">
                <path fill="#000" d="M73,50c0-12.7-10.3-23-23-23S27,37.3,27,50 M30.9,50c0-10.5,8.5-19.1,19.1-19.1S69.1,39.5,69.1,50">
                <animateTransform 
                    attributeName="transform" 
                    attributeType="XML" 
                    type="rotate"
                    dur="1s" 
                    from="0 50 50"
                    to="360 50 50" 
                    repeatCount="indefinite" />
                </path>
            </svg>
            <h2 id="city"></h2>
            <img id="weathercode" src="" width="200px">
            <h1 id="temp"></h1>
            <div class="min-max-block mb-30">
                <div id="min-temp"></div>
                <div id="max-temp"></div>
            </div>
            <div id="future-temp">
                <div>
                    <div class="hourly-temp"></div>
                    <div class="hours"></div>
                </div>
                <div>
                    <div class="hourly-temp"></div>
                    <div class="hours"></div>
                </div>
                <div>
                    <div class="hourly-temp"></div>
                    <div class="hours"></div>
                </div>
                <div>
                    <div class="hourly-temp"></div>
                    <div class="hours"></div>
                </div>
                <div>
                    <div class="hourly-temp"></div>
                    <div class="hours"></div>
                </div>
            </div>
        </div>

        <script src="https://unpkg.com/axios@0.27.2/dist/axios.min.js" type="text/javascript"></script>

        <script type="text/javascript">
            function getCityInformation(latitude, longitude) {
                axios.get(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${latitude}&longitude=${longitude}`)
                .then(function (response) {
                    // handle success
                    console.log(response);
                    const data = response.data;

                    const cityToDisplay = `${data.city}, ${data.countryName}`;

                    const cityElement = document.getElementById('city');
                    cityElement.innerText = cityToDisplay;
                    document.querySelector('svg').style.display = 'none';
                })
                .catch(function (error) {
                    // handle error
                    console.log(error);
                });
            }

            function updateWeatherCode (weathercode) {
                const weatherImageElement = document.getElementById('weathercode');
                const imageFolder = "./animated-icons/"

                const currentHours = new Date().getHours();
                const isDayTime = currentHours >= 7 && currentHours <= 19;

                // styling depending on time of day
                document.body.classList.add(isDayTime ? "day" : "night");

                // weathercode = 85;

                switch(weathercode) {
                    case 0: 
                        if (isDayTime) {
                            weatherImageElement.src = imageFolder + "day.svg";
                        } else {
                            weatherImageElement.src = imageFolder + "night.svg";
                        }
                        break;

                    case 1:
                    case 2:
                    case 3:
                        weatherImageElement.src = imageFolder + "cloudy.svg"; 
                        break;

                    case 34:
                    case 48:
                        weatherImageElement.src = imageFolder + "fog.svg";
                        break;

                    case 51:
                    case 53:
                    case 55:
                        weatherImageElement.src = imageFolder + "rainy-4.svg";
                        break;

                    case 56:
                    case 57:
                    case 66:
                    case 67:
                        weatherImageElement.src = imageFolder + "sleet.svg";
                        break;

                    case 61:
                    case 63:
                    case 65:
                        weatherImageElement.src = imageFolder + "rainy-5.svg";
                        break;
                    
                    case 77:
                        weatherImageElement.src = imageFolder + "rainy-7.svg";
                        break;

                    case 80:
                    case 81:
                    case 82:
                        weatherImageElement.src = imageFolder + "rainy-6.svg";
                        break;
                    
                    case 85:
                    case 86:
                        weatherImageElement.src = imageFolder + "snowy-5.svg";
                        break;

                    case 95:
                    case 96:
                    case 99:
                        weatherImageElement.src = imageFolder + "thunder.svg";
                        break;

                    default:
                        weatherImageElement.src = ""; 
                        break;
                }
            }

            function getWeatherInformation (latitude, longitude) {
                axios.get(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&hourly=temperature_2m,weathercode`)
                .then(function (response) {
                    console.log(response);
                    const weather_data = response.data.hourly;
                    console.log(weather_data.temperature_2m);
                    console.log(weather_data.time);

                    let currentTime = new Date().toISOString();
                    currentTime = currentTime.substr(0, currentTime.length - 10) + '00';
                    const indexOfCurrentTime = weather_data.time.indexOf(currentTime);
                    console.log(currentTime);
                    console.log(indexOfCurrentTime);

                    const currentWeather = weather_data.temperature_2m[indexOfCurrentTime];
                    console.log(currentWeather);

                    const tempElement = document.getElementById('temp');
                    tempElement.innerText = `${currentWeather}째C`;

                    const currentWeatherCode = weather_data.weathercode[indexOfCurrentTime];
                    console.log(currentWeatherCode);

                    updateWeatherCode(currentWeatherCode);

                    // calculation of min and max temperature for the day
                    const startOfADay = currentTime.substr(0, currentTime.length - 5) + '00:00';
                    console.log(startOfADay)
                    const indexOfStartADay = weather_data.time.indexOf(startOfADay);
                    console.log(indexOfStartADay);
                    const tempData = weather_data.temperature_2m;
                    const currentDayWeather = tempData.slice([indexOfStartADay], [indexOfStartADay + 24]);
                    console.log(currentDayWeather);
                    const minTemp = Math.min.apply(null, currentDayWeather);
                    console.log(minTemp);
                    const maxTemp = Math.max.apply(null, currentDayWeather)
                    console.log(maxTemp);

                    const minTempElement = document.getElementById('min-temp');
                    minTempElement.innerText = `Min: ${minTemp}째C`;
                    const maxTempElement = document.getElementById('max-temp');
                    maxTempElement.innerText = `Max: ${maxTemp}째C`;

                    // calculation of time and weather for the next 5 hours
                    const futureWeatherForFiveHours = tempData.slice([indexOfCurrentTime + 1], [indexOfCurrentTime + 6]);
                    console.log(futureWeatherForFiveHours);

                    const futureFiveHours = weather_data.time.slice([indexOfCurrentTime + 1], [indexOfCurrentTime + 6]);
                    console.log(futureFiveHours);

                    for (let i = 0; i < 5; i++) {
                        const hoursTemp = futureWeatherForFiveHours[i];
                        const hours = futureFiveHours[i];

                        const element = document.getElementById("future-temp").children[i];
                        
                        const hourTempElement = element.querySelector(".hourly-temp");
                        hourTempElement.innerText = `${hoursTemp}째C`;

                        const hourElement = element.querySelector(".hours");
                        // Z indicates UTC zone; this symbol indicates that the time is in UTC, and recalculates it to the local time
                        const localHours = new Date(hours + "Z").getHours();
                        hourElement.innerText = `${localHours}:00`;
                    }

                })
            }


            function successFunction(geo) {
                console.log(geo);

                getCityInformation(geo.coords.latitude, geo.coords.longitude);
                getWeatherInformation(geo.coords.latitude, geo.coords.longitude);
            }

            function errorFunction(err) {
                console.log(err);
            }

            const debugMode = true;

            if (debugMode) {
                successFunction({coords: {latitude: 41.6, longitude: 41.6}});
            } else {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(successFunction, errorFunction);
                } else {
                    alert('It seems like Geolocation, which is required for this page, is not enabled in your browser. Please use a browser which supports it.');
                }
            }
        </script>
    </body>
</html>